# Para criar as migrations, utilize os seguintes comandos:

âš ï¸ Execute-os separadamente para evitar que o timestamp seja o mesmo para as migrations


npx sequelize migration:generate --name create-books
npx sequelize migration:generate --name create-users
npx sequelize migration:generate --name create-users-books


# E copie o conteÃºdo abaixo para seus respectivos arquivos de migration, create-books, create-users e create-user-books:


# // cole esse cÃ³digo dentro do arquivo da migration "books"

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('books', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      name: {
        allowNull: false,
        type: Sequelize.STRING,
      },
      releaseYear: {
        allowNull: false,
        type: Sequelize.INTEGER,
        field: 'release_year', // sÃ³ precisamos definir explicitamente os campos com nomes compostos, por causa da semelhanÃ§a entre camelCase e snake_case
      },
      totalPages: {
        allowNull: false,
        type: Sequelize.INTEGER,
        field: 'total_pages', // ambos comeÃ§am com letra minÃºscula, quando temos duas palavras que existe diferenÃ§a
      },
    });
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.dropTable('books');
  },
};


# // cole esse cÃ³digo dentro do arquivo da migration "users"

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('users', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      firstName: {
        allowNull: false,
        type: Sequelize.STRING,
        field: 'first_name',
      },
      lastName: {
        allowNull: false,
        type: Sequelize.STRING,
        field: 'last_name',
      },
      age: {
        allowNull: false,
        type: Sequelize.INTEGER,
      },
    });
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.dropTable('users');
  },
};



# ðŸ’¬ Como faÃ§o para criar uma chave primÃ¡ria composta em uma Migration do Sequelize?

A forma mais simples de fazer isso Ã© indicar quais campos farÃ£o parte dessa chave composta. Utilizando novamente o parÃ¢metro primaryKey. No nosso exemplo, ao invÃ©s de usar um id Ãºnico para tabela, teremos dois campos com parÃ¢metro primaryKey: true, sendo userId e bookId:

# // cole esse cÃ³digo dentro do arquivo da migration "users-books"

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('users_books', {
      userId: {
        type: Sequelize.INTEGER,
        field: 'user_id',
        references: {
          model: 'users',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
        primaryKey: true,
      },
      bookId: {
        type: Sequelize.INTEGER,
        field: 'book_id',
        references: {
          model: 'books',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
        primaryKey: true,
      },
    });
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.dropTable('users_books');
  },
};

# O Sequelize vai interpretar mais de um campo com primaryKey, como sendo a parte de uma chave primÃ¡ria composta, impedindo que combinaÃ§Ãµes repetidas possam ser inseridas nessa tabela! Note ainda, que esses campos tambÃ©m sÃ£o chaves estrangeiras, dada suas referencias (references) a outras tabelas.

Depois disso, teremos que criar as seeds com informaÃ§Ãµes para podermos, enfim, testar nossa nova association:



# Para evitar problemas com a nomenclatura dos arquivos de seeds, rode os comandos a seguir separadamente.

npx sequelize seed:generate --name books
npx sequelize seed:generate --name users
npx sequelize seed:generate --name user-books


# Copie os cÃ³digos abaixo para seus respectivos arquivos dentro da pasta seeders:

# // cole esse cÃ³digo dentro do arquivo da seed "books"

module.exports = {
  up: async (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert(
      'books',
      [
        { name: 'O que o sol faz com as flores', release_year: 2017, total_pages: 159 },
        { name: 'Ensinando a transgredir: A educaÃ§Ã£o como prÃ¡tica da liberdade', release_year: 2017, total_pages: 288 },
        { name: 'Cem Anos de SolidÃ£o', release_year: 1967, total_pages: 419 },
        { name: 'Primeiros Pesadelos', release_year: 2022, total_pages: 300 },
      ],
      {},
    );
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.bulkDelete('books', null, {});
  },
};

# // cole esse cÃ³digo dentro do arquivo da seed "users"

module.exports = {
  up: async (queryInterface, _Sequelize) => {
    return queryInterface.bulkInsert(
      'users',
      [
        {
          first_name: 'Graciliano',
          last_name: 'Ramos',
          age: 61,
        },
        {
          first_name: 'BrenÃ©',
          last_name: 'Brown',
          age: 56,
        },
        {
          first_name: 'Djamila',
          last_name: 'Ribeiro',
          age: 42,
        },
      ],
      {},
    );
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.bulkDelete('users', null, {});
  },
};



# // cole esse cÃ³digo dentro do arquivo da seed "user-books"

module.exports = {
  up: async (queryInterface, _Sequelize) => {
    return queryInterface.bulkInsert(
      'users_books',
      [
        { user_id: 1, book_id: 1 },
        { user_id: 1, book_id: 3 },
        { user_id: 2, book_id: 1 },
        { user_id: 2, book_id: 2 },
        { user_id: 3, book_id: 1 },
        { user_id: 3, book_id: 2 },
        { user_id: 3, book_id: 3 },
      ],
      {},
    );
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.bulkDelete('users_books', null, {});
  },
};
















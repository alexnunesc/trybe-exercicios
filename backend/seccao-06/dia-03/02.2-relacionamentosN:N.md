# 02.1-relacionamentosN:N.md

env $(cat .env) npx sequelize db:drop
env $(cat .env) npx sequelize db:create
env $(cat .env) npx sequelize db:migrate
env $(cat .env) npx sequelize db:seed:all



# Vamos criar um service para recuperar todos os livros de um usuário pelo seu id:


# // src/services/userBook.service.js

const { User, Book } = require('../models');

const getUsersBooksById = (id) => User.findOne({
  where: { id },
  include: [{ model: Book, as: 'books', through: { attributes: [] } }],
});

module.exports = {
  getUsersBooksById,
};


# // src/controllers/userBook.controller.js

const userBookService = require('../services/userBook.service');

const getUsersBooksById = async (req, res) => {
  try {
    const { id } = req.params;
    const user = await userBookService.getUsersBooksById(id);

    if (!user)
      return res.status(404).json({ message: 'Pessoa não encontrada' });

    return res.status(200).json(user);
  } catch (e) {
    console.log(e.message);
    res.status(500).json({ message: 'Algo deu errado' });
  }
};

module.exports = {
  getUsersBooksById,
};

# // const express = require('express');
const userBookController = require('./controllers/userBook.controller');

// const app = express();
// app.use(express.json());

app.get('/userbooks/:id', userBookController.getUsersBooksById);

// module.exports = app;

Agora, inicie a aplicação usando o comando env $(cat .env) npm run dev e faça uma requisição do tipo GET para o endpoint localhost:3001/userbooks/1 e verifique a resposta para a pessoa.

# Nota: a propriedade through: { attributes: [] } deve estar presente, pois sem ela, em cada book, apareceriam todos seus respectivos users. Tente fazê-lo sem e veja a diferença no resultado!




